/**************************************************************************************************
*** Class Name 	      	   : ErrorLoggerEmailParser
*** Class Description      : This Class is Parse all the Emails which is generated by salesforce
*** Author                 : Coreflex Solutions
*** Class Created Date     : 
*** Configurable Parameters:
*        End Point URL     :
*        Custom Labels Used:
*        Custom Object Used: 
*** Change Management      :
*        Change #          : 
*        Change Description:
*        Modified Date     :
*        Modified By       :
**************************************************************************************************/



global class ErrorLoggerEmailParser implements Messaging.InboundEmailHandler {
    
    global Messaging.InboundEmailResult handleInboundEmail(Messaging.inboundEmail email, Messaging.InboundEnvelope envelope){ 
        
        Messaging.InboundEmailResult result = new Messaging.InboundEmailResult();
         Error_Logger__c mailLogger= new Error_Logger__c();
        try {
            String  emailBody = email.htmlBody;
            
            if(!string.isblank(emailBody)){
                system.debug('email boduy'+emailBody);
                String userName = emailBody.substringBetween('Current User: ', '(').trim();
                System.debug('userName:-'+userName);
                User userNameID = [select id, name from user where name =: userName];                
                system.debug('userNameID'+userNameID);
               
                mailLogger.Error_Message__c =emailBody.stripHtmlTags();
                mailLogger.Brief_Description__c=email.subject;
                mailLogger.TransactionDateTime__c= emailBody.substringBetween('Start time:', 'Duration').replace('<br>', '').trim();                
                mailLogger.Component_Name__c=emailBody.substringBetween('Name: ', '\n').replace('<br>', '');
                mailLogger.Component_Type__c='Unknown';
                mailLogger.Input__c='Unknown';
                mailLogger.Object_Name__c='Unknown';
                mailLogger.Status__c='Open';
                mailLogger.User_Name__c=string.valueOf(userNameID.id);
                mailLogger.User_ID__c=string.valueOf(userNameID.id);
                insert mailLogger;
                
               
            }else if(email.subject.contains('Apex governor limit')){
                
                String userName = email.plainTextBody.substringBetween('By user/organization:', '/').trim();
                 
                mailLogger.Error_Message__c=email.plainTextBody;
                mailLogger.Brief_Description__c =email.subject;
                mailLogger.Component_Name__c=email.plainTextBody.substringBetween('Operation: ', '\n').replace('<br>', '');
                mailLogger.Component_Type__c='Unknown';
                mailLogger.Input__c='Unknown';
                mailLogger.Object_Name__c='Unknown';
                mailLogger.Status__c='Open';
                mailLogger.TransactionDateTime__c= string.valueOf(system.now());
                mailLogger.User_Name__c=userName;
                mailLogger.User_ID__c=string.valueOf(userName);
                insert mailLogger;
                
                
            }
            else{                
                
                String userName = email.plainTextBody.substringBetween('Apex script unhandled trigger exception by user/organization: ', '/').trim();
                //User userNameID = [select id, name from user where id =: userName];
                
                
               
                mailLogger.Brief_Description__c =email.subject;                
                mailLogger.Error_Message__c=email.plainTextBody;
                mailLogger.Component_Name__c=email.plainTextBody.substringBetween('OpportunityTrigger: ', '\n').replace('<br>', '');
                mailLogger.Component_Type__c='Unknown';
                mailLogger.Input__c='Unknown';
                mailLogger.Object_Name__c='Unknown';
                mailLogger.Status__c='Open';
                mailLogger.TransactionDateTime__c= string.valueOf(system.now());
                mailLogger.User_Name__c=string.valueOf(userName);
                mailLogger.User_ID__c=string.valueOf(userName);
                insert mailLogger;
                system.debug('test'+mailLogger);
            }
        }
        catch (Exception e) {
              System.debug('Exception caught is: ' + e);
        }
        
        return result;
    }
}